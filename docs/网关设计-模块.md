---
- tag:
  - go
---

# 模块介绍

## main

### main.go

程序入口，初始化并启动所有模块

加载配置。
初始化日志记录，初始化指标统计。

初始化全局资源（HTTP服务）。

初始化并启动核心业务模块。（会话管理器，逻辑处理器，TCP处理器，HTTP处理器，热重载处理器）

## interfal

### config

配置模块，初始化配置。

#### config.go

配置结构体定义。

#### load.go

加载配置的逻辑。

### session

会话管理模块

#### session_manager.go

基于 Channel 管理 session。

#### session.go

Session相关逻辑。

#### types.go

结构体定义。

### tcp

tcp 服务模块。监听和处理TCP请求和响应。

#### listener.go

监听指定端口。

#### reader.go

读取请求。

#### writer.go

返回响应。

### logic

逻辑处理模块。

#### process.go

处理发送过来的Reader请求，并将其请求到后端。

#### types.go

### http

HTTP模块。启动服务和注册路由。

#### handle.go

处理指定路由的处理逻辑。

### proto

protobuf相关的编码和解码模块。

#### proto.go

封装后的protobuf编码和解码逻辑。

## config

### config.json

配置定义文件。

## proto

### message.proto

protobuf定义文件。

## 客户端请求处理流程

``` mermaid
sequenceDiagram
    participant Client
    participant TL as TCP Listener
    participant Reader
    participant SM as Session Manager
    participant LP as Logic Processor
    participant Backend

    Note over Client, Backend: 1. 建立连接
    Client->>TL: TCP Connect
    TL->>SM: 发送AddSessionMsg(conn)
    SM->>SM: 创建Session，存入Map
    SM->>Reader: 启动Reader Goroutine
    SM->>Writer: 启动Writer Goroutine

    Note over Client, Backend: 2. 请求处理
    Client->>Reader: 发送PB2数据帧
    loop 读取循环
        Reader->>Reader: 解包、解码(PB2)
        Reader->>LP: 通过logicReqChan发送LogicRequest
    end
    LP->>LP: 从channel消费请求
    LP->>LP: 协议转换(PB2->PB3)
    LP->>Backend: HTTP POST (PB3)
    Backend-->>LP: HTTP Response (PB3)
    LP->>LP: 协议转换(PB3->PB2)
    LP->>SM: 调用GetSession(sessionId)
    SM-->>LP: 返回目标Session
    LP->>Writer: 通过session.responseChan发送响应
    Writer->>Client: 编码(PB2)、打包、发送
```

## 服务端推送处理流程

``` mermaid
sequenceDiagram
    participant Backend
    participant HH as HTTP Handler
    participant SM as Session Manager
    participant Writer
    participant Client

    Backend->>HH: POST /push/{sessionId} (PB3数据)
    HH->>SM: 调用GetSession(sessionId)
    SM-->>HH: 返回目标Session
    HH->>HH: 协议转换(PB3->PB2)
    HH->>Writer: 通过session.responseChan发送数据
    Writer->>Client: 编码(PB2)、打包、发送
```
